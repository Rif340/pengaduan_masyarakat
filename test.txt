<?php

require 'koneksi.php';

session_start();

if (isset($_POST['login'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];

    $result = mysqli_query($conn, "SELECT * FROM masyarakat WHERE username = '$username'");

    // cek apakah ada hasil dari query
    if (mysqli_num_rows($result) === 1) {
        $row = mysqli_fetch_assoc($result);

        $_SESSION['nik'] = $row['nik'];

        if (password_verify($password, $row['password'])) {
            echo "
                <script>
                    alert('Selamat datang di layanan MRHS');
                    document.location.href = '../home.php';
                </script>
            ";
        } else {
            echo "
                <script>
                    alert('Password yang Anda masukkan salah');
                    document.location.href = '../login.php';
                </script>
            ";
        }
    } else {
        echo "
            <script>
                alert('Akun anda belum terdaftar');
                document.location.href = '../login.php';
            </script>
        ";
    }
}



<?php
require 'koneksi.php';
session_start();
$join = mysqli_query($conn, "SELECT * FROM masyarakat JOIN pengaduan ON masyarakat.nik = pengaduan.nik");

$nik = $_SESSION['nik'];
$laporan = htmlspecialchars($_POST['isi_laporan']);
$namaFoto = $_FILES['foto']['name'];
$asalFoto = $_FILES['foto']['tmp_name'];
move_uploaded_file($asalFoto, "../img/$namaFoto");


$laporanBaru = mysqli_query($conn, "INSERT INTO pengaduan VALUES ('', NOW(), '$nik', '$laporan', '$namaFoto', '0')");

if ($laporanBaru) {
    echo "
        <script>
            alert('Laporan anda sudah berhasil terkirim');
            window.location.href = '../detailPengaduan.php';
        </script>
    ";
} else {
    echo "
        <script>
            alert('Gagal mengirim laporan. Silakan coba lagi.');
            window.location.href = '../pengaduan.php';
        </script>
    ";
}


<?php
require 'koneksi.php';

session_start();

if (isset($_SESSION['nik'])) {
    header("Location:home.php");
}

$nik = $_POST['nik'];
$nama = strtolower(stripslashes($_POST['nama']));
$username = strtolower(stripslashes($_POST['username']));
$password = mysqli_real_escape_string($conn, $_POST['password']);
$telp = $_POST['telp'];

// cek username sudah ada atau belum
$result = mysqli_query($conn, "SELECT * FROM masyarakat WHERE username='$username'");

if(mysqli_fetch_assoc($result)){
    echo "
        <script>
            alert('Username yang anda masukan sudah ada');
            document.location.href = '../register.php';
        </script>
         ";
}
// enkripsi password
$password = password_hash($password, PASSWORD_DEFAULT);

// tambahkan user baru ke database
$data = mysqli_query($conn, "INSERT INTO masyarakat VALUES ('$nik','$nama','$username','$password','$telp')");
if($data){
    echo "
        <script>
            alert('Akun anda sudah berhasil terdaftar');
            document.location.href = '../home.php';
        </script>
         ";
}
return mysqli_affected_rows($conn);